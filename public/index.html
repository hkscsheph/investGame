<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investment Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Microsoft JhengHei', sans-serif;
        background: #f4f4f9;
        padding: 20px;
      }
      .container {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .hidden {
        display: none !important;
      }
      .btn {
        width: 100%;
        padding: 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn:hover {
        background: #2980b9;
      }
      .btn-gm {
        background: #e74c3c;
      }
      .btn-gm:hover {
        background: #c0392b;
      }

      /* Layouts */
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-bottom: 20px;
      }
      .row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .col {
        flex: 1;
      }

      /* Player UI */
      .stats-bar {
        display: flex;
        justify-content: space-around;
        background: #ecf0f1;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .stat-box {
        text-align: center;
        font-weight: bold;
        font-size: 1.2em;
      }
      .control-group {
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      /* GM UI */
      .gm-panel {
        border: 2px solid #e74c3c;
        padding: 20px;
        border-radius: 8px;
      }
      .player-row {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
      }
      .submitted-badge {
        background: #2ecc71;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
      }
      .waiting-badge {
        background: #95a5a6;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
      }

      input[type='number'] {
        padding: 5px;
        width: 60px;
        text-align: center;
      }
      input[type='range'] {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="text-align: center">üí∞ Investment Simulator</h1>

      <div id="loginScreen">
        <h2>Identity</h2>
        <input
          type="text"
          id="playerNameInput"
          placeholder="Nickname"
          style="width: 100%; padding: 10px; margin-bottom: 10px"
        />
        <button class="btn" onclick="login('player')">Join as Player</button>
        <hr />
        <input
          type="password"
          id="gmPasswordInput"
          placeholder="GM Password (admin123)"
          style="width: 100%; padding: 10px; margin-bottom: 10px"
        />
        <button class="btn btn-gm" onclick="login('gm')">Login as GM</button>
        <p id="loginMsg" style="color: red; text-align: center"></p>
      </div>

      <div id="playerUI" class="hidden">
        <div class="stats-bar">
          <div class="stat-box">
            Round <span id="pRound">1</span>/<span id="pMaxRound">5</span>
          </div>
          <div class="stat-box">Balance $<span id="pBalance">10,000</span></div>
        </div>

        <div class="chart-container">
          <canvas id="playerChart"></canvas>
        </div>

        <div id="allocationControls">
          <h3>üìä Allocation Strategy</h3>
          <div class="control-group">
            <label
              >üõ°Ô∏è Bonds (Safe)
              <span style="float: right"
                ><span id="valA">50</span>%</span
              ></label
            >
            <input type="range" id="rangeA" value="50" min="0" max="100" />
          </div>
          <div class="control-group">
            <label
              >üìà Stocks (Mod)
              <span style="float: right"
                ><span id="valB">30</span>%</span
              ></label
            >
            <input type="range" id="rangeB" value="30" min="0" max="100" />
          </div>
          <div class="control-group" style="background: #fdfefe">
            <label
              >üöÄ Crypto (Risk)
              <span style="float: right"
                ><span id="valC">20</span>%</span
              ></label
            >
            <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #e67e22">
              Auto-calculated remainder.
            </p>
          </div>
          <div
            id="totalAllocMsg"
            style="text-align: center; font-weight: bold; color: green"
          >
            Total: 100%
          </div>
          <button id="submitBtn" class="btn" onclick="submitAllocation()">
            Submit
          </button>
        </div>

        <div
          id="waitingMessage"
          class="hidden"
          style="
            text-align: center;
            padding: 20px;
            background: #e8f8f5;
            margin-top: 20px;
          "
        >
          <h3 style="color: #27ae60">‚úÖ Submitted</h3>
          <p>Waiting for market results...</p>
        </div>

        <div style="margin-top: 20px; max-height: 150px; overflow-y: auto">
          <h4>Log:</h4>
          <ul id="resultsList" style="padding-left: 20px"></ul>
        </div>
      </div>

      <div id="gmUI" class="hidden gm-panel">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h2>üéÆ GM Control</h2>
          <div>
            Round:
            <span id="gmRound" style="color: red; font-weight: bold">1</span> /
            <span id="gmMaxRound">5</span>
          </div>
        </div>

        <div class="chart-container" style="height: 250px">
          <canvas id="gmChart"></canvas>
        </div>

        <div class="row">
          <div class="col">
            <h3>Players (<span id="submittedCount">0</span> Ready)</h3>
            <div
              id="gmPlayerRows"
              style="max-height: 200px; overflow-y: auto"
            ></div>
          </div>
          <div
            class="col"
            style="background: #eee; padding: 15px; border-radius: 8px"
          >
            <h3>Market Rates (%)</h3>
            <div style="margin-bottom: 10px">
              <label
                >Bonds: <input type="number" id="gmRateA" value="5"
              /></label>
            </div>
            <div style="margin-bottom: 10px">
              <label
                >Stocks: <input type="number" id="gmRateB" value="10"
              /></label>
            </div>
            <div style="margin-bottom: 20px">
              <label
                >Crypto: <input type="number" id="gmRateC" value="-20"
              /></label>
            </div>
            <button class="btn btn-gm" onclick="gmFinishRound()">
              Process Round
            </button>

            <hr style="margin: 20px 0" />
            <h4>Game Settings</h4>
            <label
              >Total Rounds:
              <input
                type="number"
                id="settingMaxRounds"
                value="5"
                style="width: 50px"
            /></label>
            <button
              class="btn"
              style="background-color: #7f8c8d; margin-top: 5px"
              onclick="gmRestart()"
            >
              üîÑ Apply & Restart Game
            </button>
          </div>
        </div>
      </div>

      <div
        id="gameOverScreen"
        class="hidden"
        style="text-align: center; padding: 50px"
      >
        <h1 style="color: #e74c3c">üèÅ GAME OVER</h1>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let myRole = null;

      // Player Data
      let pHistory = [10000];
      let pLabels = ['Start'];
      let playerChartRef = null;

      // GM Data
      let gmChartRef = null;

      // --- CHART FUNCTIONS ---
      function initPlayerChart() {
        if (playerChartRef) playerChartRef.destroy();
        playerChartRef = new Chart(document.getElementById('playerChart'), {
          type: 'line',
          data: {
            labels: pLabels,
            datasets: [
              {
                label: 'My Balance',
                data: pHistory,
                borderColor: '#3498db',
                fill: true,
              },
            ],
          },
          options: { responsive: true, maintainAspectRatio: false },
        });
      }

      function initGMChart(players) {
        if (gmChartRef) gmChartRef.destroy();

        // Prepare datasets from players object
        const datasets = Object.values(players).map((p, index) => {
          const colors = [
            '#e74c3c',
            '#3498db',
            '#9b59b6',
            '#2ecc71',
            '#f1c40f',
            '#34495e',
          ];
          return {
            label: p.name,
            data: p.history,
            borderColor: colors[index % colors.length],
            fill: false,
            tension: 0.1,
          };
        });

        // Determine labels based on the longest history
        let maxLen = 0;
        Object.values(players).forEach(
          (p) => (maxLen = Math.max(maxLen, p.history.length))
        );
        const labels = Array.from({ length: maxLen }, (_, i) =>
          i === 0 ? 'Start' : `R${i}`
        );

        gmChartRef = new Chart(document.getElementById('gmChart'), {
          type: 'line',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
          },
        });
      }

      // --- CORE ---
      function showScreen(id) {
        document
          .querySelectorAll('.container > div')
          .forEach((d) => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
      }

      function login(type) {
        const name = document.getElementById('playerNameInput').value;
        const password = document.getElementById('gmPasswordInput').value;
        socket.emit('login', { type, name, password });
      }

      socket.on('loginSuccess', (data) => {
        myRole = data.type;
        if (myRole === 'gm') {
          showScreen('gmUI');
          document.getElementById('gmMaxRound').innerText =
            data.state.maxRounds;
          document.getElementById('settingMaxRounds').value =
            data.state.maxRounds;
          updateGMUI(data.state);
        } else {
          showScreen('playerUI');
          document.getElementById('pBalance').innerText =
            data.playerData.balance.toLocaleString();
          document.getElementById('pMaxRound').innerText = data.state.maxRounds;
          // Clean init
          pHistory = [10000];
          pLabels = ['Start'];
          initPlayerChart();
          updatePlayerRoundState(data.state.round);
        }
      });

      socket.on('gameOver', () => showScreen('gameOverScreen'));

      // --- RESTART LOGIC (FIXED) ---
      socket.on('gameRestarted', (data) => {
        // 1. Reset Data
        pHistory = [data.balance];
        pLabels = ['Start'];
        document.getElementById('pBalance').innerText =
          data.balance.toLocaleString();
        document.getElementById('pMaxRound').innerText = data.maxRounds;
        document.getElementById('resultsList').innerHTML = ''; // Clear log

        // 2. Reset UI
        if (playerChartRef) {
          playerChartRef.data.labels = pLabels;
          playerChartRef.data.datasets[0].data = pHistory;
          playerChartRef.update();
        }
        showScreen('playerUI');
        // Round will be updated by 'newRoundStarted' event next
      });

      // --- PLAYER LOGIC ---
      const rangeA = document.getElementById('rangeA');
      const rangeB = document.getElementById('rangeB');

      function updateSliders() {
        let a = parseInt(rangeA.value),
          b = parseInt(rangeB.value);
        if (a + b > 100) {
          b = 100 - a;
          rangeB.value = b;
        }
        let c = 100 - a - b;
        document.getElementById('valA').innerText = a;
        document.getElementById('valB').innerText = b;
        document.getElementById('valC').innerText = c;
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('totalAllocMsg');

        if (c < 0) {
          msg.innerText = 'Error';
          msg.style.color = 'red';
          btn.disabled = true;
        } else {
          msg.innerText = 'Total: 100%';
          msg.style.color = 'green';
          btn.disabled = false;
        }
        return { a, b, c };
      }

      rangeA.addEventListener('input', updateSliders);
      rangeB.addEventListener('input', updateSliders);

      function submitAllocation() {
        socket.emit('submitAllocation', updateSliders());
      }

      socket.on('submissionConfirmed', () => {
        document.getElementById('allocationControls').classList.add('hidden');
        document.getElementById('waitingMessage').classList.remove('hidden');
      });

      socket.on('roundResult', (data) => {
        document.getElementById('pBalance').innerText = Math.floor(
          data.newBalance
        ).toLocaleString();

        // Update Chart
        pHistory.push(data.newBalance);
        pLabels.push(`R${data.round}`);
        playerChartRef.update();

        // Update Log
        const li = document.createElement('li');
        const color = data.gain >= 0 ? 'green' : 'red';
        li.innerHTML = `Rd ${
          data.round
        }: <span style="color:${color}">$${data.gain.toFixed(
          0
        )}</span> (Bal: $${Math.floor(data.newBalance)})`;
        document.getElementById('resultsList').prepend(li);
      });

      socket.on('newRoundStarted', (r) => updatePlayerRoundState(r));

      function updatePlayerRoundState(r) {
        document.getElementById('pRound').innerText = r;
        document
          .getElementById('allocationControls')
          .classList.remove('hidden');
        document.getElementById('waitingMessage').classList.add('hidden');
      }

      // --- GM LOGIC ---
      socket.on('gmUpdate', (data) => {
        updateGMUI(data.state, data.players);
      });

      function updateGMUI(state, players = {}) {
        document.getElementById('gmRound').innerText = state.round;
        document.getElementById('gmMaxRound').innerText = state.maxRounds;

        // Update List
        const rows = document.getElementById('gmPlayerRows');
        rows.innerHTML = '';
        let count = 0,
          total = 0;
        Object.values(players).forEach((p) => {
          total++;
          if (p.submitted) count++;
          rows.innerHTML += `
                <div class="player-row">
                    <span>${p.name} ${p.submitted ? '‚úÖ' : '‚è≥'}</span>
                    <span>$${Math.floor(p.balance)}</span>
                </div>`;
        });
        document.getElementById(
          'submittedCount'
        ).innerText = `${count}/${total}`;

        // Update GM Chart
        if (Object.keys(players).length > 0) {
          initGMChart(players);
        }
      }

      function gmFinishRound() {
        const rates = {
          a: parseFloat(document.getElementById('gmRateA').value),
          b: parseFloat(document.getElementById('gmRateB').value),
          c: parseFloat(document.getElementById('gmRateC').value),
        };
        socket.emit('gmProcessRound', rates);
      }

      function gmRestart() {
        const rounds = document.getElementById('settingMaxRounds').value;
        if (confirm(`Restart game with ${rounds} rounds?`)) {
          socket.emit('gmRestartGame', { maxRounds: rounds });
        }
      }

      updateSliders();
    </script>
  </body>
</html>
