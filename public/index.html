<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡æ¨¡æ“¬å¤§å¸«</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn:hover { background: #2980b9; }
        .btn-gm { background: #e74c3c; }
        .btn-gm:hover { background: #c0392b; }
        
        /* ä½ˆå±€èˆ‡åœ–è¡¨ */
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 20px; }
        .row { display: flex; gap: 20px; margin-bottom: 20px; }
        .col { flex: 1; }
        
        /* ç©å®¶ä»‹é¢ */
        .stats-bar { display: flex; justify-content: space-around; background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-box { text-align: center; font-weight: bold; font-size: 1.2em; color: #2c3e50; }
        .control-group { padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; }
        
        /* GM ä»‹é¢ */
        .gm-panel { border: 2px solid #e74c3c; padding: 20px; border-radius: 8px; }
        .player-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        
        input[type=number] { padding: 5px; width: 60px; text-align: center; }
        input[type=range] { width: 100%; }
        
        /* ç‹€æ…‹æ–‡å­— */
        .status-ready { color: #27ae60; font-weight: bold; }
        .status-wait { color: #95a5a6; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">ğŸ’° æŠ•è³‡æ¨¡æ“¬å¤§å¸«</h1>

    <div id="loginScreen">
        <h2>è«‹é¸æ“‡èº«åˆ†</h2>
        <input type="text" id="playerNameInput" placeholder="è¼¸å…¥æ‚¨çš„æš±ç¨±" style="width:100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
        <button class="btn" onclick="login('player')">ä»¥ç©å®¶èº«åˆ†åŠ å…¥</button>
        <hr style="margin: 20px 0;">
        <input type="password" id="gmPasswordInput" placeholder="ç®¡ç†å“¡å¯†ç¢¼ (admin123)" style="width:100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
        <button class="btn btn-gm" onclick="login('gm')">ä»¥ç®¡ç†å“¡ (GM) ç™»å…¥</button>
        <p id="loginMsg" style="color:red; text-align: center;"></p>
    </div>

    <div id="playerUI" class="hidden">
        <div class="stats-bar">
            <div class="stat-box">å›åˆ <span id="pRound">1</span> / <span id="pMaxRound">5</span></div>
            <div class="stat-box">è³‡ç”¢ $<span id="pBalance">10,000</span></div>
        </div>
        
        <div class="chart-container">
            <canvas id="playerChart"></canvas>
        </div>

        <div id="allocationControls">
           <h3>ğŸ“Š æœ¬å›åˆè³‡ç”¢é…ç½®</h3>
           <div class="control-group">
               <label>ğŸ›¡ï¸ æ”¿åºœå‚µåˆ¸ (ç©©å¥) <span style="float:right; color:#2980b9; font-weight:bold;"><span id="valA">50</span>%</span></label>
               <input type="range" id="rangeA" value="50" min="0" max="100">
           </div>
           <div class="control-group">
               <label>ğŸ“ˆ è‚¡ç¥¨å¸‚å ´ (å¹³è¡¡) <span style="float:right; color:#2980b9; font-weight:bold;"><span id="valB">30</span>%</span></label>
               <input type="range" id="rangeB" value="30" min="0" max="100">
           </div>
           <div class="control-group" style="background: #fdfefe;">
               <label>ğŸš€ åŠ å¯†è²¨å¹£ (æ¿€é€²) <span style="float:right; color:#2980b9; font-weight:bold;"><span id="valC">20</span>%</span></label>
               <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #e67e22;">å‰©é¤˜è³‡é‡‘å°‡è‡ªå‹•æŠ•å…¥æ­¤é …ã€‚</p>
           </div>
           <div id="totalAllocMsg" style="text-align: center; font-weight: bold; color:green;">ç¸½è¨ˆ: 100%</div>
           <button id="submitBtn" class="btn" onclick="submitAllocation()">æäº¤é…ç½®</button>
       </div>

       <div id="waitingMessage" class="hidden" style="text-align: center; padding: 20px; background: #e8f8f5; margin-top: 20px; border-radius: 8px;">
           <h3 style="color: #27ae60;">âœ… é…ç½®å·²æäº¤</h3>
           <p>æ­£åœ¨ç­‰å¾…å¸‚å ´é–‹ç›¤...</p>
       </div>
       
       <div style="margin-top: 20px; max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px;">
           <h4>äº¤æ˜“ç´€éŒ„:</h4>
           <ul id="resultsList" style="padding-left: 20px;"></ul>
       </div>
    </div>

    <div id="gmUI" class="hidden gm-panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ğŸ® ç®¡ç†å“¡æ§åˆ¶å°</h2>
            <div style="font-size: 1.2em;">å›åˆ: <span id="gmRound" style="color: #c0392b; font-weight: bold;">1</span> / <span id="gmMaxRound">5</span></div>
        </div>

        <div class="chart-container" style="height: 250px;">
            <canvas id="gmChart"></canvas>
        </div>

        <div class="row">
            <div class="col">
                <h3>ç©å®¶åˆ—è¡¨ (<span id="submittedCount">0</span> å·²å°±ç·’)</h3>
                <div id="gmPlayerRows" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="col" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h3>è¨­å®šæœ¬å›åˆæ¼²è·Œ (%)</h3>
                <div style="margin-bottom: 10px;">
                    <label>ğŸ›¡ï¸ å‚µåˆ¸: <input type="number" id="gmRateA" value="5"></label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label>ğŸ“ˆ è‚¡ç¥¨: <input type="number" id="gmRateB" value="10"></label>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>ğŸš€ åŠ å¯†: <input type="number" id="gmRateC" value="-20"></label>
                </div>
                <button class="btn btn-gm" onclick="gmFinishRound()">çµç®—å›åˆ</button>
                
                <hr style="margin: 20px 0;">
                <h4>éŠæˆ²è¨­å®š</h4>
                <label>è¨­å®šç¸½å›åˆæ•¸: <input type="number" id="settingMaxRounds" value="5" style="width: 50px;"></label>
                <button class="btn" style="background-color: #7f8c8d; margin-top: 5px;" onclick="gmRestart()">ğŸ”„ å¥—ç”¨è¨­å®šä¸¦é‡æ–°é–‹å§‹</button>
            </div>
        </div>
    </div>
    
    <div id="gameOverScreen" class="hidden" style="text-align: center; padding: 50px;">
        <h1 style="color: #e74c3c;">ğŸ éŠæˆ²çµæŸ</h1>
        <p>è«‹æŸ¥çœ‹æœ€çµ‚æ’åèˆ‡è³‡é‡‘ã€‚</p>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myRole = null;
    
    // ç©å®¶æ•¸æ“š
    let pHistory = [10000];
    let pLabels = ['èµ·å§‹'];
    let playerChartRef = null;

    // GM æ•¸æ“š
    let gmChartRef = null;

    // --- åœ–è¡¨åŠŸèƒ½ ---
    function initPlayerChart() {
        if(playerChartRef) playerChartRef.destroy();
        playerChartRef = new Chart(document.getElementById('playerChart'), {
            type: 'line',
            data: {
                labels: pLabels,
                datasets: [{ 
                    label: 'æˆ‘çš„è³‡ç”¢', 
                    data: pHistory, 
                    borderColor: '#3498db', 
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function initGMChart(players) {
        if(gmChartRef) gmChartRef.destroy();
        
        // å°‡ç©å®¶æ•¸æ“šè½‰æ›ç‚ºåœ–è¡¨ Datasets
        const datasets = Object.values(players).map((p, index) => {
            const colors = ['#e74c3c', '#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#34495e'];
            return {
                label: p.name,
                data: p.history,
                borderColor: colors[index % colors.length], // æ¯å€‹ç©å®¶åˆ†é…ä¸åŒé¡è‰²
                fill: false,
                tension: 0.1
            };
        });

        // æ ¹æ“šæœ€é•·çš„æ­·å²ç´€éŒ„ä¾†æ±ºå®š X è»¸æ¨™ç±¤
        let maxLen = 0;
        Object.values(players).forEach(p => maxLen = Math.max(maxLen, p.history.length));
        const labels = Array.from({length: maxLen}, (_, i) => i === 0 ? 'èµ·å§‹' : `R${i}`);

        gmChartRef = new Chart(document.getElementById('gmChart'), {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: false } }
            }
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function login(type) {
        const name = document.getElementById('playerNameInput').value;
        const password = document.getElementById('gmPasswordInput').value;
        socket.emit('login', { type, name, password });
    }

    socket.on('loginSuccess', (data) => {
        myRole = data.type;
        if (myRole === 'gm') {
            showScreen('gmUI');
            document.getElementById('gmMaxRound').innerText = data.state.maxRounds;
            document.getElementById('settingMaxRounds').value = data.state.maxRounds;
            updateGMUI(data.state);
        } else {
            showScreen('playerUI');
            document.getElementById('pBalance').innerText = data.playerData.balance.toLocaleString();
            document.getElementById('pMaxRound').innerText = data.state.maxRounds;
            
            // åˆå§‹åŒ–æ•¸æ“š
            pHistory = [10000];
            pLabels = ['èµ·å§‹'];
            initPlayerChart();
            updatePlayerRoundState(data.state.round);
        }
    });

    socket.on('gameOver', () => showScreen('gameOverScreen'));

    // --- é‡ç½®é‚è¼¯ (ä¿®å¾©ç‰ˆ) ---
    socket.on('gameRestarted', (data) => {
        // 1. é‡ç½®æœ¬åœ°æ•¸æ“š
        pHistory = [data.balance];
        pLabels = ['èµ·å§‹'];
        document.getElementById('pBalance').innerText = data.balance.toLocaleString();
        document.getElementById('pMaxRound').innerText = data.maxRounds;
        document.getElementById('resultsList').innerHTML = ''; // æ¸…ç©ºæ—¥èªŒ
        
        // 2. é‡ç½®åœ–è¡¨
        if(playerChartRef) {
            playerChartRef.data.labels = pLabels;
            playerChartRef.data.datasets[0].data = pHistory;
            playerChartRef.update();
        }
        showScreen('playerUI');
        // "newRoundStarted" äº‹ä»¶æœƒéš¨å¾Œè§¸ç™¼ä¸¦æ›´æ–°å›åˆæ•¸é¡¯ç¤º
    });

    // --- ç©å®¶é‚è¼¯ ---
    const rangeA = document.getElementById('rangeA');
    const rangeB = document.getElementById('rangeB');

    function updateSliders() {
        let a = parseInt(rangeA.value), b = parseInt(rangeB.value);
        if (a + b > 100) { b = 100 - a; rangeB.value = b; }
        let c = 100 - a - b;
        document.getElementById('valA').innerText = a;
        document.getElementById('valB').innerText = b;
        document.getElementById('valC').innerText = c;
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('totalAllocMsg');
        
        if (c < 0) { msg.innerText = "éŒ¯èª¤"; msg.style.color="red"; btn.disabled = true; }
        else { msg.innerText = "ç¸½è¨ˆ: 100%"; msg.style.color="green"; btn.disabled = false; }
        return { a, b, c };
    }
    
    rangeA.addEventListener('input', updateSliders);
    rangeB.addEventListener('input', updateSliders);

    function submitAllocation() {
        socket.emit('submitAllocation', updateSliders());
    }

    socket.on('submissionConfirmed', () => {
        document.getElementById('allocationControls').classList.add('hidden');
        document.getElementById('waitingMessage').classList.remove('hidden');
    });

    socket.on('roundResult', (data) => {
        document.getElementById('pBalance').innerText = Math.floor(data.newBalance).toLocaleString();
        
        // æ›´æ–°åœ–è¡¨
        pHistory.push(data.newBalance);
        pLabels.push(`R${data.round}`);
        playerChartRef.update();

        // æ›´æ–°æ—¥èªŒ
        const li = document.createElement('li');
        const color = data.gain >= 0 ? 'green' : 'red';
        const sign = data.gain >= 0 ? '+' : '';
        li.innerHTML = `R${data.round}: <span style="color:${color}">${sign}$${data.gain.toFixed(0)}</span> (é¤˜é¡: $${Math.floor(data.newBalance)})`;
        document.getElementById('resultsList').prepend(li);
    });

    socket.on('newRoundStarted', (r) => updatePlayerRoundState(r));
    
    function updatePlayerRoundState(r) {
        document.getElementById('pRound').innerText = r;
        document.getElementById('allocationControls').classList.remove('hidden');
        document.getElementById('waitingMessage').classList.add('hidden');
    }

    // --- GM é‚è¼¯ ---
    socket.on('gmUpdate', (data) => {
        updateGMUI(data.state, data.players);
    });

    function updateGMUI(state, players = {}) {
        document.getElementById('gmRound').innerText = state.round;
        document.getElementById('gmMaxRound').innerText = state.maxRounds;
        
        // æ›´æ–°åˆ—è¡¨
        const rows = document.getElementById('gmPlayerRows');
        rows.innerHTML = '';
        let count = 0, total = 0;
        Object.values(players).forEach(p => {
            total++;
            if(p.submitted) count++;
            const statusClass = p.submitted ? 'status-ready' : 'status-wait';
            const statusText = p.submitted ? 'âœ… å·²å°±ç·’' : 'â³ ç­‰å¾…ä¸­';
            
            rows.innerHTML += `
                <div class="player-row">
                    <span>${p.name} <span class="${statusClass}">${statusText}</span></span>
                    <span>$${Math.floor(p.balance)}</span>
                </div>`;
        });
        document.getElementById('submittedCount').innerText = `${count}/${total}`;

        // æ›´æ–° GM åœ–è¡¨ (åªè¦æœ‰ç©å®¶å°±ç¹ªè£½)
        if(Object.keys(players).length > 0) {
            initGMChart(players);
        }
    }

    function gmFinishRound() {
        const rates = {
            a: parseFloat(document.getElementById('gmRateA').value),
            b: parseFloat(document.getElementById('gmRateB').value),
            c: parseFloat(document.getElementById('gmRateC').value),
        };
        socket.emit('gmProcessRound', rates);
    }

    function gmRestart() {
        const rounds = document.getElementById('settingMaxRounds').value;
        if(confirm(`ç¢ºå®šè¦å°‡ç¸½å›åˆæ•¸è¨­ç‚º ${rounds} ä¸¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ`)) {
            socket.emit('gmRestartGame', { maxRounds: rounds });
        }
    }

    updateSliders();
</script>
</body>
</html>